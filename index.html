<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Base64/0.3.0/base64.js"></script>
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.71/jquery.csv-0.71.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/1.1.1/js/md5.min.js"></script>
  <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous">
  <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" integrity="sha512-K1qjQ+NcF2TYO/eI3M6v8EiNYZfA95pQumfvcVrTHtwQVDG+aHRqLi/ETn2uB+1JqwYqVG3LIvdm9lj6imS/pQ==" crossorigin="anonymous"></script>

    <style type="text/css">
    
    .edit {
        border-radius: 2px;
        font-size: 1.633333em;
        position: relative;
        margin-top:0px;
        top: 30px;
        left: 598px;
        color:rgba(36, 36, 49, 0.63);
    }

    .edit:after {
        position: absolute;
        top: 22px;
        bottom: 0;
        left: 564px;
        right: 0;
        font-size: 18px; 
        color: #FFF;
        line-height: 0;
        text-align: center;
    }

    .delete {
        border-radius: 2px;
        position: relative;
    }

    .delete:after {
        position: absolute;
        top: 22px;
        bottom: 0;
        left: 564px;
        right: 0;
        content: "\274c"; /* use the hex value here... */
        font-size: 18px; 
        color: #FFF;
        line-height: 0;
        text-align: center;
    }

    .event-trigger {
      display:inline;
      margin:0 0 0 10px;
    }

    .icon.string {
        background-position: 0 0px;
        width:16px;
    }

    .icon.numeric {
        background-position: 0 -15px;
        width:16px;
    }

    .hover.numeric {
        background-position: -16px -15px;
        width:16px;
    }

    .icon.boolean {
        background-position: 0 -30px;
        width:16px;
    }

    .hover.boolean {
        background-position: -16px -30px;
        width:16px;
    }

    .icon.date {
        background-position: 0 -60px;
        width:16px;
    }

    .hover.date {
        background-position: -16px -60px;
        width:16px;
    }

    .icon.list {
        background-position: 0 -45px;
        width:16px;
    }

    .hover.list {
        background-position: -16px -45px;
        width:16px;
    }

    .icon {
        background: url(https://cdn.mxpnl.com/cache/86e7a9704481d99cba363aa05a2e32d4/images/widgets/property_filter/property_filter_icons.png);
        width: 16px;
        height: 15px;
        /*float: left;*/
        line-height: 24px;
        margin: 8px 7px 7px 8px;
    }

    .panel-default {
      width:650px;
    }

    .panel-group {
      width:700px;
      font-size:14px;
    }

    .panel-heading i {
      margin-right:10px;
    }

    .property {
      display:block;
      height:20px;
    }

    .property-name, .property-type, .property-definition {
      display:inline-block;
      margin: 0 0 -4px 5px;
    }

    .property-name {
      font-weight: 800;
      width:180px;
    }

    .property-name i {
      margin-right:10px;
    }

    .property-type {
      width:80px;
    }

    .property-definition {
      margin: 0 0 0 10px;
    }

    </style>

  </head>

  <body class="mixpanel-platform-body spec">
    <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#fileModal">
      Import / Export Spec
    </button>
    <div class="dropdown">
      <button id="dLabel" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Dropdown trigger
        <span class="caret"></span>
      </button>
      <ul class="dropdown-menu" aria-labelledby="dLabel">
      </ul>
    </div>    
    <button id="run" class="btn btn-primary" style="display: none;">Run</button>
    <div class="panel-group" id="accordion" role="tablist">
    </div>
  <!-- Upload Modal -->
  <div class="modal fade" id="fileModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title">Welcome to spec checker</h4>
        </div>
        <div class="modal-body">
          <div class='postSpec'>
            Hey we will post spec here
          </div>
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title">Upload a file</h4>
        </div>
        <div class="modal-body">
          <div class='csvUpload'>
            <input style="opacity:0" id="uploadFile" placeholder="Choose File" disabled="disabled" class="" />
              <span>Upload CSV</span>
              <input id="uploadBtn" type="file" class="upload" placeholder="Upload File" />
          </div>
        </div>
        <div class="modal-footer">
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <script type="text/javascript">

  /*
  **  Debug issues
  **    On Edit Names, second word gets cut off
  **    Run on every upload
  **    Expand not working properly
  **  To-Do
  **    Values for Properties?
  **    Make spec an object with the methods
  **    Sample Specs per vertical
  */

    getQueryParam = function(param) {
        param = param.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
        var regexS = "[\\?&]" + param + "=([^&#]*)",
            regex = new RegExp( regexS ),
            results = regex.exec(document.URL);
        if (results === null || (results && typeof(results[1]) !== 'string' && results[1].length)) {
            return '';
        } else {
            return decodeURIComponent(results[1]).replace(/\+/g, ' ');
        }
    };

    /* Bitwise Encoding
    ** takes stringified and key
    ** returns XOR
    */
    vernam = function(msg, key) {
      var l = key.length;
      var fromCharCode = String.fromCharCode;
      return msg.replace(/[\s\S]/g, function(c, i) {
        return fromCharCode(key.charCodeAt(i % l) ^ c.charCodeAt(0));
      });
    };

    /* XHR promises
    */

    request = function(method, url) {
        return new Promise(function (resolve, reject) {
            var xhr = new XMLHttpRequest();
            xhr.open(method, url);
            xhr.onload = resolve;
            xhr.onerror = reject;
            xhr.send();
        });
    };

    var Project = function(){}
    /* Render a dropdown using MPSelect
    ** Needs rewrite can't modify after initialization
    */
    Project.prototype.renderDropdown = function() {
          $('.dropdown-menu').empty()
          for ( var i = this.specs.length - 1; i >= 0; i--) {
            var created
            created = this['specs'][i]['created_at'] || "Work In Progress"
            var htmlStr = "<li><a id='spec' data-id='" + i + "'>" + created +"</a></li>"
            $(".dropdown-menu").last().append(htmlStr)

          }
          $('#run').show()
    }

    /*
    ** Get a projects spec from our glorious backend
    */
    Project.prototype.getSpecs = function(){
      var id = vernam(this.apiKey, this.apiSecret);
      var url = 'https://spec-api.herokuapp.com/specs/read?key=' + md5(id);
      return request('GET', url)
    };

    Project.prototype.render = function(){
    };

    Project.prototype.checkSpec = function(spec){
      $.each(spec, function(index, eventInfo) {
        currentEvent = eventInfo
        eventName = currentEvent.event;
        eventProps = currentEvent.$properties;
        checker(eventName, eventProps);
      });
    };

    /*
    ** Post a spec to our glorious backend
    */

    Project.prototype.postSpec = function (spec){
      var cypher = this.vernam(JSON.stringify(spec), this.apiKey);
      var id = this.vernam(this.apiKey, this.apiSecret);
      var url = 'http://spec-api.herokuapp.com/specs/create?key=' + md5(id) + '&spec=' + btoa(cypher);

      return request('GET', url)
    };

    Project.prototype.specWrite = function (spec){
      for (var i = 0, n = spec.length; i < n; i++) {
        // debugger
          var event = spec[i]["event"];
          var cssSafeEvent = this.cssSafe(event)
          var eventTrigger = spec[i]["trigger"];
          $("#accordion").append(
            [
              // "<div class='edit'></div>",
              "<div class='edit fa fa-pencil-square-o fa-lg'></div>",
              "<div class='delete'></div>",
              "<div class='panel panel-default'>",
              "<div class='panel-heading' id='" + cssSafeEvent + "'>",
              "<a class='accordion' href='#" + cssSafeEvent + "'>" + event + "</a>",
              "<div class='event-trigger'>"+eventTrigger+"</div>",            
              "</div>",
              "<div id='" + cssSafeEvent  +"' class='properties'>",
              "<div class='panel-body'>",
              "</div>",
              "</div>"
            ].join(''));

          var properties = spec[i]['$properties'];
          for(var j = properties.length - 1; j >= 0; j--){
            var property = properties[j];
            var propName = property["name"];
            var propType = property["type"] || ''
            propType = propType.toLowerCase();
            var cssSafeName = this.cssSafe(propName)
            var propDefinition = property["definition"];
            $(".panel-body").last().append([
              "<div class='property'>",
              "<div class='property-name' id='" + cssSafeEvent + "-" + cssSafeName + "'>" + propName + "</div>",
              "<div class='property-type icon " + propType + "'></div>",
              "<div class='property-definition'>" + propDefinition + "</div>",
              "</div>"
              ].join(''));
          };
        };
        this.checkSpec(spec)
    }

    Project.prototype.cssSafe = function(string){
      return string.replace('$','').replace(' ','_');
    }

    Project.prototype.csvImport = function(file){
      var eventColumn;
      var propColumn;
      var superPropColumn;
      var header;
      var csvArray;
      var eventTrigger;
      var eventTriggerCol;
      var propertyDefinition;
      var propertyDefinitionCol;
      var superPropDefinition;
      var superPropDefinitionCol;
      var propertyType;
      var propertyTypeCol;
      var superPropType;
      var superPropTypeCol;
      var eventIndex = -1;
      var events = [];
      var superProps = [];
      var data = $.csv.toArrays(file);
      header = data[0];
      // console.log(header)
      // console.log(data)
      eventColumn = header.indexOf('Event');
      eventTriggerCol = header.indexOf('Event Trigger');
      propColumn = header.indexOf('Property');
      propTypeCol = header.indexOf('Property Type');
      superPropCol = header.indexOf('Super Property');
      superPropTypeCol = header.indexOf('Super Property Type');
      propertyDefinitionCol = header.indexOf('Property Definition');
      superPropDefinitionCol = header.indexOf('Super Property Definition');
      if (data && data.length > 0) {
        csvArray = data.slice(1, data.length);
        _.each(csvArray, function(arr){
          var property = arr[propColumn];
          var eventName = arr[eventColumn];
          var eventTrigger = arr[eventTriggerCol]
          var superProperty = arr[superPropCol];
          var propertyType = arr[propTypeCol];
          var superPropType = arr[superPropTypeCol];
          var propertyDefinition = arr[propertyDefinitionCol];
          var superPropDefinition = arr[superPropDefinitionCol];

          if (eventName){
            eventIndex++;
            events.push({ event: eventName, trigger: eventTrigger, $properties: [] });
          }

          if (property) {
            propObj = {name: property, type: propertyType, definition: propertyDefinition};
            events[eventIndex]['$properties'].push(propObj);
          }

          if (superProperty) {
            superPropObj = {name: superProperty, type: superPropType, definition: superPropDefinition};
            superProps.push(superPropObj);
          }
          // console.log(arr)
        });
        _.each(events, function(event){
          event.$properties = new Set(event.$properties.concat(superProps));
          event.$properties = Array.from(event['$properties']);
        });
        return {spec: events};
      } else {
        /* alert('No data to import!'); */
      }
    }
    /* Import File
    ** Takes an event
    ** Returns promise
    */
    Project.prototype.importSpec = function (evt) {
      if (window.File && window.FileReader && window.FileList && window.Blob) {
        var file = evt.target.files[0];
        var reader = new FileReader();
        var deferred = $.Deferred();
        reader.readAsText(file);

        reader.onload = function(event) {
          deferred.resolve(event.target.result);
        };
        reader.onerror = function() {
          deferred.reject(this);
        };
      } else {
        alert('The File APIs are not fully supported in this browser!');
      }
      return deferred.promise();
    }

    /* Exports spec to csv
    ** Takes JSON Spec
    ** Returns CSV
    */
    Project.prototype.exportSpec = function (spec) {
      function getSubKeys(listOfDicts) {
        subkeys = {};
        //For each profile
        _.each(_.keys(listOfDicts), function(profileIndex){
          var profilePropData = listOfDicts[profileIndex]['$properties'];
          _.each(_.keys(profilePropData), function(property){
            try {
              subkeys[property] = true;
            } catch (e) {}
          });
        });
        return subkeys;
      };
    //If JSONData is not an object then JSON.parse will parse the JSON string in an Object
      var data = typeof spec != 'object' ? JSON.parse(spec) : spec;
      var CSV = ''

      //Create list of profiles
      var event_list = [];
      for (i = 0; i < data.length; i++) {
        _.each(_.keys(data[i]), function(profileIndex){
        var profileData = data[i][profileIndex];
        event_list.push(profileData)
        });
      };

      //Write the header with people properties
      subkeys = getSubKeys(event_list)
      var row = ''
      row += '$distinct_id, '
      _.each(_.keys(subkeys), function(property) {
        row += property + ','
      })
      CSV += row + '\r\n';

      //Write the data
      _.each(_.keys(event_list), function(eventIndex) {
        var event = event_list[eventIndex]
        var row = ''
        try {
          row += event['$distinct_id'] + ','
        } catch (e) {
          row += ','
        }
        _.each(_.keys(subkeys), function(property) {
          data = event['$properties'][property]
          if (!data) {
            row += ','
          } else if (_.isString(data)) {
            row += data.replace(/,/g, "|") + ","
          } else {
            row += data + ","
          }
          //if (data.indexOf(',') > -1)
        });
        CSV += row + '\r\n';
      });


      //Generate a file name
      var fileName = ReportTitle.replace(/ /g,"_");

      //Initialize file format you want csv or xls
      var uri = 'data:text/csv;charset=utf-8,' + escape(CSV);

      // Now the little tricky part.
      // you can use either>> window.open(uri);
      // but this will not work in some browsers
      // or you will not get the correct file extension

      //this trick will generate a temp <a /> tag
      var link = document.createElement("a");
      link.href = uri;

      //set the visibility hidden so it will not effect on your web-layout
      link.style = "visibility:hidden";
      link.download = fileName + ".csv";

      //this part will append the anchor tag and remove it after automatic click
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    /*
    ** Validates a blob as a valid spec
    */
    Project.prototype.validateSpec = function(blob){
      var spec;
      try {
        spec = JSON.parse(vernam(atob(blob), MP.api.apiKey));
      } catch (e){
        console.log('Spec not encoded');
      }
      return spec;
    }

    checker = function(name, properties) {
      var endpoint = 'api/2.0/events/properties/toptypes'
      MP.api.query(endpoint, {event:name, limit: 255} ).done(function(results){
        var cssSafe = name.replace('$','').replace(' ','_')
        var eventState = true;
        var propertiesState = true;
        if ($.isEmptyObject(results)) {
          eventState = false
        }
        propNamesExist = results;
        // yellow prop but no type
        // red no prop
        // green both prop and type
        $.each(properties, function(index, Prop) {
          var cssSafeProp = Prop.name.replace('$','').replace(' ','_')
          var id = cssSafe + "-" + cssSafeProp

          console.log(id);
          var $prop = $(document.getElementById(id))
          if (propNamesExist[Prop.name]) {
            // debugger
            var propType = propNamesExist[Prop.name].type
            if ($prop.next().hasClass(propType)) {
              $prop.prepend("<i class='fa fa-check' style='color: green;'></i>");
            } else {
              $prop.prepend("<i class='fa fa-warning' style='color: orange;'></i>");
              propertiesState = false;
            }
          } else {
            $prop.prepend("<i class='fa fa-ban' style='color: red;'></i>");
            propertiesState = false;
          }
        })

        if (eventState && propertiesState) {
          $(document.getElementById(cssSafe)).prepend("<i class='fa fa-check' style='color: green;'></i>");
        } else if (eventState && !propertiesState) {
          $(document.getElementById(cssSafe)).prepend("<i class='fa fa-warning' style='color: orange;'></i>");
        } else {
        }
      })
    };


    $('#run').on('click', function(e){
      Specs.specWrite(MP.$('#specs-list').MPSelect('value'));
    });

    Specs = window.Specs = new Project()
    MP.api.on('mpplatform.credentialsRegistered', function(){
      Specs.apiKey = MP.api.apiKey
      Specs.apiSecret = MP.api.apiSecret
      Specs.specs = []
      Specs.getSpecs()
      .then(function(e) {
        console.log(e);
        console.log(e.target.response);
        var tmpSpecs = JSON.parse(e.target.response)['spec'];
        for ( var i = tmpSpecs.length - 1; i >= 0; i--) {
          var blob = tmpSpecs[i]['spec']
          var spec = Specs.validateSpec(blob)
          tmpSpecs[i]['spec'] = spec
          if (spec) { Specs.specs.push(tmpSpecs[i]) }
        }
        Specs.renderDropdown()
      }, function(e) {
        console.log(e);
        console.log('Error');
      })
    })

    if (getQueryParam('api_key')) { MP.api.trigger('mpplatform.credentialsRegistered');}
    MP.api.MAX_SIMULTANEOUS_QUERIES = 10
    /*
    Specs.postSpec('blah')
    .then(function(e) {
      console.log(e.target.response);
    }, function(e) {
      console.log(e);
      console.log('Error');
    })
    */

    document.getElementById("uploadBtn").onchange = function () {
      document.getElementById("uploadFile").value = this.value.split("\\")[this.value.split("\\").length - 1];
    };


    // The event listener for the file upload
  $('.dropdown').on('click', '#spec', function(e) {
    Specs.specWrite(Specs.specs[e.target.getAttribute('data-id')]['spec'])
  });
  document.addEventListener("click", "#spec", function(e){
  });
  document.getElementById('uploadBtn').addEventListener('change', function(evt){
    Specs.importSpec(event).then(
      function (spec) {
        Specs.specs.push(Specs.csvImport(spec))
        Specs.renderDropdown()
        $('#fileModal').modal('toggle')
      })
  }
  , false);

  // Event listener for new accordion in jQuery
  $("body").on("click",".panel-heading", function(){
    $(this).siblings(".properties").slideToggle();
  });

  // Delete the event if you click the button. Check to make sure before you do.
  $("body").on("click",".delete", function(){
    var element = $(this);
    // debugger
    if (window.confirm("Are you sure you want to delete this event?")) {
      $(this).next(".panel-default").remove();
      $(this).remove();
      //Add code here to remove items from actual spec
    }
  });

  // Make fields editable



  </script>
  </body>
</html>

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="./style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Base64/0.3.0/base64.js"></script>
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/0.71/jquery.csv-0.71.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/1.1.1/js/md5.min.js"></script>
  <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous">
  <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" integrity="sha512-K1qjQ+NcF2TYO/eI3M6v8EiNYZfA95pQumfvcVrTHtwQVDG+aHRqLi/ETn2uB+1JqwYqVG3LIvdm9lj6imS/pQ==" crossorigin="anonymous"></script>
  <!-- Booboo style sheet -->

  </head>

  <body class="mixpanel-platform-body spec">
    <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#fileModal">
      Import / Export Spec
    </button>
    <div class="spec-items panel-group flex-container" id="accordian" role="tablisti">

      <!--<input class="input-events" type="text" placeholder="Add an event. Press enter.">-->
      <!--<button class="save-button">Save</button>-->

    </div>
  <!-- Upload Modal -->
  <div class="modal fade" id="fileModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title">Welcome to spec checker</h4>
        </div>
        <div class="modal-body">
          <div class='postSpec'>
            Hey we will post spec here
          </div>
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title">Upload a file</h4>
        </div>
        <div class="modal-body">
          <div class='csvUpload'>
            <input style="opacity:0" id="uploadFile" placeholder="Choose File" disabled="disabled" class="" />
              <span>Upload CSV</span>
              <input id="uploadBtn" type="file" class="upload" placeholder="Upload File" />
          </div>
        </div>
        <div class="modal-footer">
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->

  <script type="text/javascript">

  /*
  **  Debug issues
  **    On Edit Names, second word gets cut off
  **    Run on every upload
  **    Expand not working properly
  **  To-Do
  **    Values for Properties?
  **    Make spec an object with the methods
  **    Sample Specs per vertical
  */

  // On document ready, check for spec in localStorage. Parse if it's there.
  /*
  function event() {
    initialize: function(){
    },
    properties: function(){
    }
    render : function(){
    }
  }
  */
  var ProjectSpecs = function () {
    this.render = function(){
    };
    this.checkSpec = function(spec){
      $.each(spec, function(index, eventInfo) {
        currentEvent = eventInfo
        eventName = currentEvent['event'];
        eventProps = Array.from(currentEvent['$properties']);
        checker(eventName, eventProps);
      });
    };

    /* Bitwise Encoding
    ** takes stringified and key
    ** returns XOR
    */

    this.vernam = function(msg, key) {
      var l = key.length;
      var fromCharCode = String.fromCharCode;
      return msg.replace(/[\s\S]/g, function(c, i) {
        return fromCharCode(key.charCodeAt(i % l) ^ c.charCodeAt(0));
      });
    };

    /* XHR promises
    */

    this.request = function(method, url) {
        return new Promise(function (resolve, reject) {
            var xhr = new XMLHttpRequest();
            xhr.open(method, url);
            xhr.onload = resolve;
            xhr.onerror = reject;
            xhr.send();
        });
    };

    /*
    ** Post a spec to our glorious backend
    */

    this.postSpec = function (spec){
      var cypher = this.vernam(JSON.stringify(spec), MP.api.apiKey);
      var id = this.vernam(MP.api.apiKey, MP.api.apiSecret);
      var url = 'http://spec-api.herokuapp.com/specs/create?key=' + md5(id) + '&spec=' + btoa(cypher);

      this.request('GET', url)
        .then(function(e) {
          console.log(e.target.response);
        }, function(e) {
          console.log(e);
          console.log('Error');
        })
    };

    /*
    ** Get a projects spec from our glorious backend
    */
    this.specWrite = function (spec){
      for (var i = 0, n = spec.length; i < n; i++) {
          var event = spec[i]['event'];

          $(".spec-items").append(
              [
                "<div class='events panel panel-default'>",
                "<div class='panel-heading event-name' role='table' id='" + event + "'>",
                "<a role='button' data-toggle='collapse' data-parent='#accordian' href='#" + event + "'>" + event + "</a>",
                "</div>",
                "<i class='fa fa-caret-left expand-button'></i>",
                "<div id=" + event  + " class='panel-collapse collapse in' role='tabpanel'>",
                "<div class='panel-body properties'>",
                "</div>",
                "</div>"
              ].join('\n'));

          var properties = spec[i]['$properties']
          properties.forEach(function(property){
            $(".properties").last().append("<div class='property-name' id='" + event + "-" + property + "'>" + property + "</div>");
          });
        };

        debugger
        specs = new ProjectSpecs()
        specs.checkSpec(spec)
    }

    this.getSpecs = function(){
      var id = this.vernam(MP.api.apiKey, MP.api.apiSecret);
      var url = 'http://spec-api.herokuapp.com/specs/read?key=' + md5(id);

      this.request('GET', url)
        .then(function(e) {
          console.log(e);
          console.log(e.target.response);
          this.specs = JSON.parse(e.target.response);
        }, function(e) {
          console.log(e);
          console.log('Error');
        })
    };
    /* Exports spec to csv
    ** Takes JSON Spec
    ** Returns CSV
    */
    this.exportSpec = function (spec) {
      debugger;
    };

    }



  /*
  $(document).ready(function(){
    if (localStorage.getItem("spec")) {
      console.log("Found a spec!");
      saved_list = JSON.parse(localStorage.getItem("spec"));
      saved_date = localStorage.getItem("saved_date");

      if (saved_date != null) {
        $(".spec-items").append("<span class='saved-date'> Last saved on: "+saved_date+"</span>");
      }
      // console.log(saved_list);


    };
  });
  */

  checker = function(name, properties) {
    MP.api.topProperties(name).done(function(results){
      var eventState = true;
      var propertiesState = true;
      if ($.isEmptyObject(results.json)) {
        eventState = false
      }
      propNamesExist = results.json;
      $.each(properties, function(index, desiredProp) {
        id = name + "-" + desiredProp
        console.log(id);
        if (!propNamesExist[desiredProp]) {
          $(document.getElementById(id)).prepend("<i class='fa fa-ban' style='color: red;'></i>")
          propertiesState = false
        } else {
          $(document.getElementById(id)).prepend("<i class='fa fa-check' style='color: green;'></i>")
        }
      })

      if (eventState && propertiesState) {
        $(document.getElementById(name)).prepend("<i class='fa fa-check' style='color: green;'></i>")
      } else if (eventState && !propertiesState) {
        $(document.getElementById(name)).prepend("<i class='fa fa-warning' style='color: orange;'></i>")
      } else {
        $(document.getElementById(name)).prepend("<i class='fa fa-ban' style='color: red;'></i>")
      }

    })
  };

  /*
  // Listen for presses of the enter key
  $("body").on("keyup","input", function(e){
      if(e.keyCode == 13)
      {
          $(this).trigger("enterKey");
      }
  });

  // Add new event name if you press enter key on the main input field
  $(".input-events").bind("enterKey", function(){
    value = $(this).val();
    $(".spec-items").append("<div class='events'><div class='event-name'>"+value+"</div><i class='fa fa-caret-left expand-button'></i><span class='property-info'># properties</span><div class='properties'><input class='input-properties' placeholder='Add a property. Press enter.'></input></div></div>");
    $(this).val("");
  });

  // Add new property name if you press enter key on input
  $("body").on("keyup",".input-properties", function(e){
    if (e.keyCode == 13) {
      value = $(this).val();
      $(this).parent(".properties").append("<div class='property-name'>"+value+"</div>");
      $(this).val("");
    }
  });

  // Make event name div "editable"
  $("body").on("click",".event-name", function(){
    value = $(this).text();
    $(this).replaceWith("<input class='edit-field' value="+value+"></input>");
    // value = "";
  });

  // Make property name div "editable"
  $("body").on("click",".property-name", function(){
    value = $(this).text();
    $(this).replaceWith("<input class='edit-field' value="+value+"></input>");
    // value = "";
  });

  // Switch editable div back to regular element on enter. Delete if blank.
  $("body").on("keyup",".edit-field", function(e){
      if(e.keyCode == 13 || e.keyCode == 27)
      {
          value = $(this).val();
          if (value == "" || value == " ") {
            $(this).parent(".events").remove();
            console.log("Removed element.");
          } else {
            $(this).replaceWith("<div class='event-name'>"+value+"</div>");
          }
      }
  });
  */

  // Expand + icon on click and turn to - sign when expanded. Also check number of properties nested under event.
  $("body").on("click",".expand-button", function(e){
    var $target = $(e.target)
    if ($target.hasClass("fa-caret-left")) {
      $target.removeClass("fa-caret-left");
      $target.addClass("fa-caret-down");
    } else {
      $target.addClass("fa-caret-left");
      $target.removeClass("fa-caret-down");
    };
    $(this).siblings(".properties").toggle();
  });

  /*
  // Build list of JSON from spec items, stringify, then save to localStorage.
  $(".save-button").on("click",function(){
    list = [];

    // Build list of JSON objects.
    $(".events").each(function(){
      props = [];
      json = {};

      event = $(this).children(".event-name").text();
      json["event"] = event;

      $(this).children(".properties").each(function(){
        json["$properties"] = [];
        $(this).children(".property-name").each(function(){
          prop = $(this).text();
          props.push(prop);
          json["$properties"] = props;
        });
      });
      list.push(json);
    });
    // console.log(list);

    // Stringify and save to localStorage.
    if (typeof(Storage) !== "undefined") {
        localStorage.setItem("spec", JSON.stringify(list));
        localStorage.setItem("saved_date", new Date());
        console.log(JSON.stringify(list));
        alert("Saved!");
      } else {
      alert("Sorry! Your browser does not support local storage.");
    };
  });
  */

      /* Upload and Store data client-side */

      Specs = window.Specs = new ProjectSpecs()
      Specs.getSpecs()
      document.getElementById("uploadBtn").onchange = function () {
        document.getElementById("uploadFile").value = this.value.split("\\")[this.value.split("\\").length - 1];
      };


      // The event listener for the file upload
      document.getElementById('uploadBtn').addEventListener('change', upload, false);

      // Method that checks that the browser supports the HTML5 File API
      function browserSupportFileUpload() {
          var isCompatible = false;
          if (window.File && window.FileReader && window.FileList && window.Blob) {
          isCompatible = true;
          }
          return isCompatible;
      }

      // Method that reads and processes the selected file
      function upload(evt) {
      if (!browserSupportFileUpload()) {
        alert('The File APIs are not fully supported in this browser!');
        } else {
          var eventColumn;
          var propColumn;
          var superPropColumn;
          var header;
          var csvArray;
          var chartData = {};
          var events = [];
          var superProps = [];
          var data = null;
          var file = evt.target.files[0];
          var reader = new FileReader();
          var eventIndex = -1;
          reader.readAsText(file);

          reader.onload = function(event) {
            var csvData = event.target.result;
            data = $.csv.toArrays(csvData);
            header = data[0];
            console.log(header)
            console.log(data)
            eventColumn = header.indexOf('Event');
            propColumn = header.indexOf('Property');
            superPropColumn = header.indexOf('Super Property');


            if (data && data.length > 0) {
              /* Create a dictionary with the transaction date and transaction amount */
              csvArray = data.slice(1, data.length);
              _.each(csvArray, function(arr){
                var property = arr[propColumn];
                var event = arr[eventColumn];
                var superProperty = arr[superPropColumn];

                if (event){
                  eventIndex++;
                  events.push({ event: event, $properties: [] });
                }

                if (property) {
                  events[eventIndex]['$properties'].push(property);
                }

                if (superProperty) {
                  superProps.push(superProperty);
                }
                console.log(arr)
              });
              _.each(events, function(event){
                event.$properties = new Set(event.$properties.concat(superProps))
              });
              return events
            } else {
              /* alert('No data to import!'); */
            }
          };
          reader.onerror = function() {
              alert('Unable to read ' + file.fileName);
          };
        }
        document.getElementById("uploadBtn").empty()
      }


  </script>
  </body>
</html>